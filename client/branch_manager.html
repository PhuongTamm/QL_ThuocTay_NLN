<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω Chi nh√°nh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üè• <span id="branchNameTitle">Chi Nh√°nh</span></h2>
            <div>
                <span class="me-3">Xin ch√†o, <b id="currentUserName">User</b></span>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="myTab">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#inventoryTab">üì¶ T·ªìn kho</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#importTab">üöö ƒê∆°n h√†ng ch·ªù nh·∫≠p</a></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="inventoryTab">
                <table class="table table-striped">
                    <thead><tr><th>Thu·ªëc</th><th>T·ªïng t·ªìn</th><th>Chi ti·∫øt L√¥ (HSD)</th></tr></thead>
                    <tbody id="inventoryBody"></tbody>
                </table>
            </div>

            <div class="tab-pane fade" id="importTab">
                <div id="pendingTransList">Loading...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        // client/js/branch.js inline logic
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth(['branch_manager']);
            loadInventory();
            loadPendingTransactions();
        });

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }

        // 1. T·∫£i t·ªìn kho
        async function loadInventory() {
            // API n√†y c·∫ßn vi·∫øt ·ªü Backend: router.get('/inventory/my-branch', ...)
            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('branchNameTitle').textContent = "Chi nh√°nh c·ªßa b·∫°n";

            const res = await fetchAPI(`/inventory?branchId=${user.branchId}`); 
            // Gi·∫£ s·ª≠ API tr·∫£ v·ªÅ list Inventory
            if(res && res.success) {
                const tbody = document.getElementById('inventoryBody');
                tbody.innerHTML = res.data.map(inv => `
                    <tr>
                        <td>${inv.medicineId.name}</td>
                        <td class="fw-bold text-primary">${inv.totalQuantity}</td>
                        <td>
                            <ul class="small mb-0 ps-3">
                                ${inv.batches.map(b => `
                                    <li>L√¥ ${b.batchCode} - HSD: ${new Date(b.expiryDate).toLocaleDateString()} (${b.quantity})</li>
                                `).join('')}
                            </ul>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // 2. T·∫£i phi·∫øu ch·ªù nh·∫≠p (Pending)
        async function loadPendingTransactions() {
            // API c·∫ßn vi·∫øt: GET /transactions/pending-import
            const res = await fetchAPI('/transactions/pending-import'); 
            const div = document.getElementById('pendingTransList');
            
            if(res && res.success && res.data.length > 0) {
                div.innerHTML = res.data.map(trans => `
                    <div class="card mb-3 border-warning">
                        <div class="card-body">
                            <h5 class="card-title">Phi·∫øu xu·∫•t: ${trans.code}</h5>
                            <p>T·ª´: Kho T·ªïng - Ng√†y: ${new Date(trans.date).toLocaleDateString()}</p>
                            <ul>
                                ${trans.details.map(d => `<li>${d.medicineId.name} - SL: ${d.quantity}</li>`).join('')}
                            </ul>
                            <button class="btn btn-success" onclick="confirmImport('${trans._id}')">X√°c nh·∫≠n Nh·∫≠p kho</button>
                        </div>
                    </div>
                `).join('');
            } else {
                div.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ phi·∫øu xu·∫•t n√†o ƒëang ch·ªù.</p>';
            }
        }

        async function confirmImport(transId) {
            if(!confirm('B·∫°n ch·∫Øc ch·∫Øn ƒë√£ nh·∫≠n ƒë·ªß h√†ng v√† mu·ªën nh·∫≠p kho?')) return;
            
            const res = await fetchAPI(`/transactions/${transId}/confirm-import`, 'PUT');
            if(res && res.success) {
                alert('Nh·∫≠p kho th√†nh c√¥ng!');
                loadPendingTransactions();
                loadInventory();
            } else {
                alert('L·ªói: ' + res.message);
            }
        }
    </script>
</body>
</html>